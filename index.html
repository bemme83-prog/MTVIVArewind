<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIVA Dual-Player v4.7 FINAL TEST</title>
    <style>
        :root { --viva-blue: #1a4a9e; --viva-yellow: #ffff00; --viva-pink: #ff00ff; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #000; font-family: 'Arial Black', sans-serif; }

        /* Portal Overlay */
        #portal-overlay { position: fixed; inset: 0; z-index: 20000; background: radial-gradient(circle, #222 0%, #000 100%); display: flex; justify-content: center; align-items: center; }
        .start-btn { padding: 25px 50px; background: var(--viva-yellow); color: var(--viva-blue); border: 5px solid var(--viva-blue); font-size: 22px; cursor: pointer; font-weight: bold; box-shadow: 8px 8px 0px var(--viva-pink); }

        /* Player Container */
        .player-container { position: absolute; inset: 0; opacity: 0; pointer-events: none; background: #000; }
        .active-player { opacity: 1; pointer-events: auto; }
        
        /* UI Elements */
        .viva-clock { position: absolute; top: 30px; left: 35px; z-index: 500; font-size: 28px; color: var(--viva-yellow); text-shadow: 3px 3px 0px var(--viva-blue); }
        #debug { position: absolute; top: 75px; left: 35px; z-index: 500; color: #00ff00; font-family: monospace; font-size: 14px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 5px; }
        
        #viva-tag { position: absolute; bottom: 25%; left: 0; z-index: 600; background: var(--viva-yellow); color: var(--viva-blue); padding: 15px 40px; border: 5px solid var(--viva-blue); box-shadow: 8px 8px 0px var(--viva-pink); transform: translateX(-110%); transition: 0.5s; }
        #viva-tag.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="portal-overlay">
        <button class="start-btn" onclick="startTestCycle()">START TEST: Musik > Clip > Musik</button>
    </div>

    <div id="viva-view">
        <div id="viva-clock" class="viva-clock">00:00</div>
        <div id="debug">Warte auf API...</div>
        <div id="viva-tag"><div id="viva-title">VIVA REWIND</div></div>
        
        <div id="div-music" class="player-container"><div id="player-music"></div></div>
        <div id="div-inter" class="player-container"><div id="player-inter"></div></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let pMusic, pInter;
        let testStep = 0; // 0: Musik1, 1: Clip, 2: Musik2, 3: Ende
        let fadeTriggered = false;
        let checkTimer;

        const musicPL = 'PLfYJatUfKgnlRa5IM0KI_ll0UyhYItnU2';
        const interPL = 'PLQ7SWY9Xieg3hXzm58s84PRe53LttQbJl';

        function onYouTubeIframeAPIReady() {
            pMusic = new YT.Player('player-music', {
                height: '100%', width: '100%',
                playerVars: { autoplay: 0, controls: 0, modestbranding: 1, rel: 0, enablejsapi: 1 },
                events: { 'onStateChange': (e) => handleState(e, 'music'), 'onReady': () => updateDebug("System bereit.") }
            });
            pInter = new YT.Player('player-inter', {
                height: '100%', width: '100%',
                playerVars: { autoplay: 0, controls: 0, modestbranding: 1, rel: 0, enablejsapi: 1 },
                events: { 'onStateChange': (e) => handleState(e, 'inter') }
            });
        }

        function startTestCycle() {
            document.getElementById('portal-overlay').style.display = 'none';
            testStep = 0; fadeTriggered = false;
            switchVisuals('music', 'none');
            pMusic.loadPlaylist({ list: musicPL, index: Math.floor(Math.random() * 50) });
            pMusic.setVolume(100);
            updateDebug("Musik 1 läuft...");
        }

        function handleState(e, type) {
            // Clip-Player Logik
            if (type === 'inter') {
                if (e.data === YT.PlayerState.PLAYING) updateDebug("Clip aktiv...");
                if (e.data === YT.PlayerState.ENDED && testStep === 1) {
                    returnToMusic();
                }
            }
            // Musik-Player Logik (Ende Testlauf)
            if (type === 'music' && e.data === YT.PlayerState.PLAYING && testStep === 0) showTag(e.target.getVideoData().title);
            if (type === 'music' && e.data === YT.PlayerState.ENDED && testStep === 2) {
                updateDebug("TEST ERFOLGREICH BEENDET.");
                pMusic.stopVideo();
            }
        }

        function returnToMusic() {
            testStep = 2;
            pInter.stopVideo(); // Playlist im Clip-Player killen
            switchVisuals('music', '0.5s'); // Schneller Rück-Schnitt
            pMusic.setVolume(100);
            pMusic.nextVideo();
            pMusic.playVideo();
            updateDebug("Musik 2 läuft...");
        }

        function switchVisuals(target, speed) {
            const dM = document.getElementById('div-music');
            const dI = document.getElementById('div-inter');
            dM.style.transition = `opacity ${speed}`;
            dI.style.transition = `opacity ${speed}`;
            
            if (target === 'music') {
                dM.classList.add('active-player'); dI.classList.remove('active-player');
            } else {
                dI.classList.add('active-player'); dM.classList.remove('active-player');
            }
        }

        function showTag(t) {
            if (!t) return;
            document.getElementById('viva-title').innerText = t;
            const tag = document.getElementById('viva-tag');
            tag.classList.add('show');
            setTimeout(() => tag.classList.remove('show'), 6000);
        }

        function updateDebug(msg) { document.getElementById('debug').innerText = msg; }

        // Der "Master Timer" (läuft jede Sekunde)
        setInterval(() => {
            document.getElementById('viva-clock').innerText = new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
            
            if (testStep === 0 && pMusic && pMusic.getPlayerState() === 1) {
                let timeLeft = pMusic.getDuration() - pMusic.getCurrentTime();
                
                // Crossfade-Start bei 6 Sekunden
                if (timeLeft <= 6 && !fadeTriggered) {
                    fadeTriggered = true;
                    testStep = 1;
                    
                    pInter.setVolume(0);
                    pInter.loadPlaylist({ list: interPL, index: 0 }); // Erster Clip
                    switchVisuals('inter', '6s'); // Langer Fade für Musik -> Clip
                    
                    // Audio-Fader (6 Sekunden lang)
                    let vol = 100;
                    let audioInterval = setInterval(() => {
                        vol -= 5;
                        if (vol <= 0) {
                            pMusic.setVolume(0); pInter.setVolume(100);
                            clearInterval(audioInterval);
                        } else {
                            pMusic.setVolume(vol); pInter.setVolume(100 - vol);
                        }
                    }, 300);
                }
            }

            // Sicherheits-Check für den Clip-Player (Watchdog)
            if (testStep === 1 && pInter && pInter.getPlayerState) {
                let interStatus = pInter.getPlayerState();
                // Wenn der Clip-Player länger als 3 Sek. auf "Puffern" oder "Fehler" steht:
                if (interStatus === 3 || interStatus === -1) {
                    // Watchdog könnte hier greifen, aber wir warten den 6s Fade ab.
                }
            }
        }, 1000);
    </script>
</body>
</html>
