<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIVA Dual-Crossfade v4.0</title>
    <style>
        :root { --viva-blue: #1a4a9e; --viva-yellow: #ffff00; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: black; font-family: 'Arial Black', sans-serif; }
        
        #portal-overlay { position: fixed; inset: 0; z-index: 20000; background: #000; display: flex; justify-content: center; align-items: center; }
        .start-btn { padding: 20px 40px; background: var(--viva-yellow); color: var(--viva-blue); border: none; font-size: 24px; cursor: pointer; border-radius: 10px; }
        
        .player-container { position: absolute; inset: 0; transition: opacity 2s ease-in-out; opacity: 0; pointer-events: none; }
        .active-player { opacity: 1; pointer-events: auto; }
        
        .viva-clock { position: absolute; top: 30px; left: 35px; z-index: 500; font-size: 28px; color: var(--viva-yellow); text-shadow: 3px 3px 0px var(--viva-blue); }
        #debug { position: absolute; top: 70px; left: 35px; z-index: 500; color: #fff; font-size: 12px; background: rgba(0,0,0,0.6); padding: 5px; }
    </style>
</head>
<body>

    <div id="portal-overlay">
        <button class="start-btn" onclick="startTest()">TEST STARTEN (Crossfade)</button>
    </div>

    <div id="viva-view">
        <div id="viva-clock" class="viva-clock">00:00</div>
        <div id="debug">System bereit...</div>
        
        <div id="div-music" class="player-container"><div id="player-music"></div></div>
        <div id="div-inter" class="player-container"><div id="player-inter"></div></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let pMusic, pInter;
        let testStep = 0; // 0=Musik, 1=Clip1, 2=Clip2, 3=Ende
        let crossfadeStarted = false;

        const musicPL = 'PLfYJatUfKgnlRa5IM0KI_ll0UyhYItnU2';
        const interPL = 'PLQ7SWY9Xieg3hXzm58s84PRe53LttQbJl';

        function onYouTubeIframeAPIReady() {
            // Player werden initialisiert, aber noch nicht geladen
            pMusic = new YT.Player('player-music', {
                height: '100%', width: '100%',
                playerVars: { autoplay: 0, controls: 0, modestbranding: 1, rel: 0, enablejsapi: 1 },
                events: { 'onStateChange': (e) => handleState(e, 'music'), 'onReady': () => updateDebug("Music Player bereit") }
            });
            pInter = new YT.Player('player-inter', {
                height: '100%', width: '100%',
                playerVars: { autoplay: 0, controls: 0, modestbranding: 1, rel: 0, enablejsapi: 1 },
                events: { 'onStateChange': (e) => handleState(e, 'inter'), 'onReady': () => updateDebug("Inter Player bereit") }
            });
        }

        function startTest() {
            document.getElementById('portal-overlay').style.display = 'none';
            updateDebug("Starte Musik...");
            testStep = 0;
            switchVisuals('music');
            pMusic.loadPlaylist({ list: musicPL, index: Math.floor(Math.random() * 50) });
            pMusic.playVideo();
        }

        function handleState(e, type) {
            if (e.data === YT.PlayerState.ENDED) {
                if (type === 'music' && testStep === 0) {
                    startInterStep(1);
                } else if (type === 'inter' && testStep === 1) {
                    startInterStep(2);
                } else if (type === 'inter' && testStep === 2) {
                    finishTest();
                }
            }
        }

        function startInterStep(step) {
            testStep = step;
            crossfadeStarted = false;
            updateDebug("Clip " + (step) + " startet");
            switchVisuals('inter');
            
            if (step === 1) {
                pInter.loadPlaylist({ list: interPL, index: 0 });
            } else {
                pInter.nextVideo();
            }
            pInter.playVideo();
            pMusic.pauseVideo();
        }

        function finishTest() {
            testStep = 3;
            updateDebug("TEST BEENDET.");
            pMusic.stopVideo();
            pInter.stopVideo();
        }

        function switchVisuals(target) {
            if (target === 'music') {
                document.getElementById('div-music').classList.add('active-player');
                document.getElementById('div-inter').classList.remove('active-player');
            } else {
                document.getElementById('div-inter').classList.add('active-player');
                document.getElementById('div-music').classList.remove('active-player');
            }
        }

        function updateDebug(msg) {
            document.getElementById('debug').innerText = msg;
            console.log(msg);
        }

        // Crossfade Überwachung
        setInterval(() => {
            document.getElementById('viva-clock').innerText = new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
            
            let activeP = (testStep === 0) ? pMusic : pInter;
            if (activeP && activeP.getPlayerState && activeP.getPlayerState() === 1) {
                let timeLeft = activeP.getDuration() - activeP.getCurrentTime();
                
                // 5 Sekunden vor Ende Crossfade-Logik
                if (timeLeft <= 5 && !crossfadeStarted) {
                    crossfadeStarted = true;
                    updateDebug("Crossfade in 5 Sek...");
                    // Hier könnte man bereits den nächsten Player lautlos starten
                }
            }
        }, 1000);
    </script>
</body>
</html>
